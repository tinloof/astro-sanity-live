---
import { loadQuery, client } from "@/sanity";
import { PAGE_QUERY, ALL_PAGES_QUERY } from "@/sanity/queries";
import type { PAGE_QUERY_RESULT, ALL_PAGES_QUERY_RESULT } from "@/sanity/types";
import Layout from "../layouts/layout.astro";
import { DebugPanel } from "@tinloof/sanity-astro/debug";
import { PortableText } from "@portabletext/react";

export async function getStaticPaths() {
  const pages = await client.fetch<ALL_PAGES_QUERY_RESULT>(ALL_PAGES_QUERY);

  return pages.map((page) => ({
    params: { slug: page.slug },
  }));
}

const { slug } = Astro.params;
const result = await loadQuery<PAGE_QUERY_RESULT>(Astro, {
  query: PAGE_QUERY,
  params: { slug },
});

if (!result.data) {
  return Astro.redirect("/404");
}

const { data } = result;
---

<Layout>
  <article>
    <h1 class="text-4xl font-bold text-gray-900 mb-6">{data.title}</h1>
    {data.content && (
      <div class="prose prose-lg prose-gray">
        <PortableText value={data.content} />
      </div>
    )}
  </article>
  <DebugPanel
    perspective={result.perspective}
    cacheStatus={result.cacheStatus}
    cacheAge={result.cacheAge}
    tags={result.tags}
    ms={result.ms}
  />
</Layout>
