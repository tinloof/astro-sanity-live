---
/**
 * Sanity Visual Editing component for Astro.
 *
 * This component enables click-to-edit functionality when the site
 * is viewed inside Sanity's Presentation tool (iframe detection).
 *
 * Add this to your layout - it will only activate when inside
 * the Presentation tool or when the visual editing cookie is set.
 *
 * @example
 * ```astro
 * ---
 * import { VisualEditing } from '@tinloof/sanity-astro/visual-editing'
 * ---
 * <VisualEditing />
 * ```
 */
import VisualEditingComponent from './visual-editing-component'

interface Props {
  /**
   * The z-index for the visual editing overlays
   * @default 9999
   */
  zIndex?: number
  /**
   * Debounce delay in ms before refreshing after mutations stop
   * @default 300
   */
  refreshDebounce?: number
}

const {
  zIndex = 9999,
  refreshDebounce = 300,
} = Astro.props
---

<VisualEditingComponent
  client:only="react"
  zIndex={zIndex}
  refreshDebounce={refreshDebounce}
/>

<script>
  import { navigate } from 'astro:transitions/client'

  // Handle refresh requests from VisualEditing component
  function handleVisualEditingRefresh() {
    // Use View Transitions to refresh without full page reload
    navigate(window.location.href, { history: 'replace' })
  }

  // Set up listener (runs once, persists across navigations)
  if (!(window as any).__visualEditingRefreshListenerAdded) {
    window.addEventListener('sanity:visual-editing-refresh', handleVisualEditingRefresh)
    ;(window as any).__visualEditingRefreshListenerAdded = true
  }
</script>
