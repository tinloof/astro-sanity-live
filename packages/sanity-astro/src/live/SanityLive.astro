---
/**
 * SanityLive component for real-time cache invalidation.
 *
 * This component subscribes to Sanity's live events and purges
 * the Cloudflare cache when content changes. Include it in your
 * layout to enable automatic cache invalidation.
 *
 * Configuration is automatically picked up from initSanity() if called,
 * otherwise falls back to environment variables.
 *
 * @example
 * ```astro
 * ---
 * import { SanityLive } from '@tinloof/sanity-astro/live'
 * ---
 * <SanityLive />
 * ```
 */
import SanityLiveComponent from './sanity-live-component'
import { getSanityConfig, getLiveConfig } from '../config-store'

interface Props {
  /**
   * Whether to refresh the page after cache purge
   * @default true
   */
  refreshOnPurge?: boolean
  /**
   * Debounce delay before refreshing (ms).
   * If initSanity() was called with live.refreshDebounce, that value is used as default.
   * @default 100
   */
  refreshDebounce?: number
  /**
   * API endpoint for cache purge.
   * If initSanity() was called with live.purgeEndpoint, that value is used as default.
   * @default '/api/sanity/purge'
   */
  purgeEndpoint?: string
}

// Get config from store (set by initSanity) or fall back to env vars
let projectId: string | undefined
let dataset: string | undefined
let apiVersion: string | undefined

try {
  const sanityConfig = getSanityConfig()
  projectId = sanityConfig.projectId
  dataset = sanityConfig.dataset
  apiVersion = sanityConfig.apiVersion
} catch {
  // getSanityConfig throws if not configured - this is expected if initSanity wasn't called
  console.warn('[SanityLive] Sanity not configured. Call initSanity() or set PUBLIC_SANITY_PROJECT_ID and PUBLIC_SANITY_DATASET.')
}

// Get live config defaults
const liveConfig = getLiveConfig()

const {
  refreshOnPurge = true,
  refreshDebounce = liveConfig.refreshDebounce,
  purgeEndpoint = liveConfig.purgeEndpoint,
} = Astro.props
---

{projectId && dataset && apiVersion && (
  <SanityLiveComponent
    client:only="react"
    projectId={projectId}
    dataset={dataset}
    apiVersion={apiVersion}
    refreshOnPurge={refreshOnPurge}
    refreshDebounce={refreshDebounce}
    purgeEndpoint={purgeEndpoint}
  />
)}

<script>
  import { navigate } from 'astro:transitions/client'

  // Handler for refresh events from SanityLive component
  function handleRefresh() {
    navigate(window.location.href, { history: 'replace' })
  }

  // Set up listener (runs once, persists across navigations)
  if (!(window as any).__sanityRefreshListenerAdded) {
    window.addEventListener('sanity:refresh', handleRefresh)
    ;(window as any).__sanityRefreshListenerAdded = true
  }
</script>
