---
import { getConfig, getTags } from './config'
import { LIVE_EVENT_COOKIE, LIVE_EVENT_COOKIE_MAX_AGE } from './constants'

// No props required - config and tags are read from internal store
type Props = Record<string, never>

const config = getConfig()
const tags = getTags()
---

<sanity-live
  data-tags={JSON.stringify(tags)}
  data-config={JSON.stringify(config)}
  data-cookie-name={LIVE_EVENT_COOKIE}
  data-cookie-max-age={LIVE_EVENT_COOKIE_MAX_AGE}
></sanity-live>

<script>
  import { createClient } from '@sanity/client'
  import { navigate } from 'astro:transitions/client'

  class SanityLive extends HTMLElement {
    #unsubscribe?: () => void

    connectedCallback() {
      const tags = JSON.parse(this.dataset.tags || '[]') as string[]
      const config = JSON.parse(this.dataset.config || '{}') as {
        projectId: string
        dataset: string
        apiVersion: string
        useCdn?: boolean
      }
      const cookieName = this.dataset.cookieName!
      const cookieMaxAge = this.dataset.cookieMaxAge!

      const client = createClient({
        projectId: config.projectId,
        dataset: config.dataset,
        apiVersion: config.apiVersion,
        useCdn: config.useCdn ?? true,
      })

      const subscription = client.live.events().subscribe({
        next: (event) => {
          if (event.type === 'message' && event.tags?.some((tag: string) => tags.includes(tag))) {
            document.cookie = `${cookieName}=${event.id}; path=/; max-age=${cookieMaxAge}; SameSite=Lax`
            navigate(window.location.href, { history: 'replace' })
          }
        },
        error: (err) => {
          if (err.name === 'CorsOriginError') {
            console.error('CORS error: Add your domain to Sanity CORS origins at sanity.io/manage')
          } else {
            console.error('Sanity live subscription error:', err)
          }
        },
      })

      this.#unsubscribe = () => subscription.unsubscribe()
    }

    disconnectedCallback() {
      this.#unsubscribe?.()
    }
  }

  customElements.define('sanity-live', SanityLive)
</script>
