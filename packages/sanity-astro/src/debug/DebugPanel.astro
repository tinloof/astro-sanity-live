---
/**
 * Debug panel component for displaying cache and query information.
 *
 * Shows visual editing status, perspective, cache status, query time, and sync tags.
 * Position is fixed to bottom-right corner.
 *
 * @example
 * ```astro
 * ---
 * import { DebugPanel } from '@tinloof/sanity-astro/debug'
 * const result = await loadQuery(Astro, { query })
 * ---
 * <DebugPanel {...result} />
 * ```
 */
import { VISUAL_EDITING_ENABLED } from '../constants'

interface Props {
  perspective: 'published' | 'drafts'
  cacheStatus?: 'HIT' | 'MISS' | 'STALE' | 'BYPASS'
  cacheAge?: number
  tags?: string[]
  ms?: number
}

const { perspective, cacheStatus, cacheAge, tags, ms } = Astro.props

const isVisualEditing = Astro.cookies.get(VISUAL_EDITING_ENABLED)?.value === 'true'

function getCacheColor(status?: string) {
  switch (status) {
    case 'HIT': return 'bg-emerald-500/90 text-white'
    case 'STALE': return 'bg-yellow-500/90 text-white'
    case 'MISS': return 'bg-orange-500/90 text-white'
    case 'BYPASS': return 'bg-gray-500/90 text-white'
    default: return 'bg-gray-500/90 text-white'
  }
}

function formatTags(tags?: string[]) {
  if (!tags || tags.length === 0) return null
  const maxDisplay = 3
  const displayed = tags.slice(0, maxDisplay)
  const remaining = tags.length - maxDisplay
  return { displayed, remaining: remaining > 0 ? remaining : 0 }
}

const formattedTags = formatTags(tags)
---

<div class="fixed bottom-4 right-4 z-50 flex flex-col gap-2 text-xs font-mono">
  <!-- Visual Editing Status -->
  <div class={`px-3 py-2 rounded-lg shadow-lg backdrop-blur-sm ${isVisualEditing ? 'bg-green-500/90 text-white' : 'bg-gray-800/90 text-gray-300'}`}>
    <div class="flex items-center gap-2">
      <span class={`w-2 h-2 rounded-full ${isVisualEditing ? 'bg-white animate-pulse' : 'bg-gray-500'}`}></span>
      <span>Visual Editing: {isVisualEditing ? 'ON' : 'OFF'}</span>
    </div>
  </div>

  <!-- Perspective -->
  <div class={`px-3 py-2 rounded-lg shadow-lg backdrop-blur-sm ${perspective === 'drafts' ? 'bg-amber-500/90 text-white' : 'bg-blue-500/90 text-white'}`}>
    <div class="flex items-center gap-2">
      <span class="w-2 h-2 rounded-full bg-white"></span>
      <span>Perspective: {perspective}</span>
    </div>
  </div>

  <!-- Cache Status -->
  {cacheStatus && (
    <div class={`px-3 py-2 rounded-lg shadow-lg backdrop-blur-sm ${getCacheColor(cacheStatus)}`}>
      <div class="flex items-center gap-2">
        <span class="w-2 h-2 rounded-full bg-white"></span>
        <span>Cache: {cacheStatus}{cacheAge !== undefined ? ` (${cacheAge}s old)` : ''}</span>
      </div>
    </div>
  )}

  <!-- Query Time -->
  {ms !== undefined && (
    <div class="px-3 py-2 rounded-lg shadow-lg backdrop-blur-sm bg-purple-500/90 text-white">
      <div class="flex items-center gap-2">
        <span class="w-2 h-2 rounded-full bg-white"></span>
        <span>Query: {ms}ms</span>
      </div>
    </div>
  )}

  <!-- Sync Tags -->
  {formattedTags && (
    <div class="px-3 py-2 rounded-lg shadow-lg backdrop-blur-sm bg-indigo-500/90 text-white max-w-xs">
      <div class="flex items-center gap-2 mb-1">
        <span class="w-2 h-2 rounded-full bg-white"></span>
        <span>Tags ({tags?.length})</span>
      </div>
      <div class="flex flex-wrap gap-1 ml-4">
        {formattedTags.displayed.map((tag) => (
          <span class="bg-white/20 px-1.5 py-0.5 rounded text-[10px] truncate max-w-[120px]" title={tag}>
            {tag.replace(/^s1:/, '')}
          </span>
        ))}
        {formattedTags.remaining > 0 && (
          <span class="bg-white/20 px-1.5 py-0.5 rounded text-[10px]">
            +{formattedTags.remaining} more
          </span>
        )}
      </div>
    </div>
  )}
</div>
